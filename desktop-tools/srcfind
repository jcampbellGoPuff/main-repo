#!/bin/zsh

# faceted search
unset show
if [[ "$1" == "-S" || "$1" == "--show-matches" ]]
then
	shift
	show=1
fi

if [ $# -eq 0 ]
then
	echo >&2 "$0: at least one pattern required"
	exit 1
fi

if [[ ${@[$#]} == -* ]]
then
	echo >&2 "$0: last argument must be a pattern, not a flag"
	exit 1
fi

function extract_flags()
{
	local start=$1
	shift
	local v=("$@")
	local next=$start

	while [[ $next < ${#v[@]} ]]
	do
		if [[ "${v[@]:$next:1}" != -* ]]
		then
			break
		fi
		echo "${v[@]:$next:1}"
		next=$((next + 1))
	done

	return $((next - count))
}

args=($@)
arg_count=${#args[@]}

arg_idx=0
egrep_options=$(extract_flags $arg_idx ${args[@]})
arg_idx=$?
all_options=($egrep_options)

pat="${args[@]:$arg_idx:1}"
all_pats=("$pat")

# Since egrep -l will produce a string of newline-delimited
# file names, we restrict the input separator to *only*
# a newline. With this setting + $(echo ...), we make a file 
# list that is usable by egrep and any spaces in the file names
# are preserved and processed correctly.
IFS=$'\n'

files=$(
	find . \
		-type d \( \
			-name node_modules \
			-o -name dist \
			-o -type d -name '.?*' \
		\) \
		-prune \
		-o \
		\( \
			-type f \
			! -name '.*' \
			! -name 'package-lock.json' \
			! -name 'yarn.lock' \
			! -name '*.log' \
		\) \
		-print0 |
	xargs -0 \
		egrep \
			$(echo $egrep_options) \
			--binary-files=without-match \
			--files-with-matches \
			"$pat"
)

if [ $? -ne 0 ]
then
	# egrep returned nothing - no results
	exit 1
fi
arg_idx=$((arg_idx + 1))

# Now iterate per pattern
while (( $arg_idx < $arg_count ))
do
		egrep_options=$(extract_flags $arg_idx ${args[@]})
		arg_idx=$?

		all_options+=($egrep_options)
		pat="${args[@]:$arg_idx:1}"
		all_pats+=("$pat")
		
		files=$(egrep \
			$(echo $egrep_options) \
			--files-with-matches \
			"$pat" \
			$(echo $files))

		if [ $? -ne 0 ]
		then
			# egrep returned nothing - no results
			exit 1
		fi
		arg_idx=$((arg_idx + 1))
done

if [[ $show == 1 ]]
then
	for (( i=0; i<${#all_pats[@]}; i++ ))
	do
		egrep_options=${all_options[@]:$i:1}
		pat=${all_pats[@]:$i:1}
		egrep \
			-H \
			$(echo $egrep_options) \
			"$pat" \
			$(echo $files)
	done | sort | uniq
else
	echo $files
fi
exit 0
